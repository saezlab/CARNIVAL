}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore); names(scores) <- names(nodeWeights)
} else {
# progenyScores <- read_csv("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/CARNIVAL_Validation/E-MTAB-2091/data/E-MTAB-2091_PROGENy.csv")
# pathwayscore <- progenyScores[,2:ncol(progenyScores)]
pathwayscore_current <- pathwayscore[1,]
nodeWeights <- NULL
for (counter_pw in 1:ncol(pathwayscoreAll)) {
ss <- abs(as.numeric(as.matrix(pathwayscoreAll[, counter_pw])))
nodeWeights <- c(nodeWeights, 1-2*(ss[1]-min(ss, na.rm = TRUE))/(max(ss, na.rm = TRUE)-min(ss, na.rm = TRUE)))
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore_current); names(scores) <- names(nodeWeights)
# names(scores) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
# names(nodeWeights) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
}
} else {
scores <- NULL
nodeWeights <- NULL
}
# Write constraints as ILP inputs
print("Writing constraints...")
if (file.exists("testFile.lp")) {file.remove("testFile.lp")}
if (file.exists("results_cplex.txt")) {file.remove("results_cplex.txt")}
ptm <- proc.time()
variables <- try(writeLPFile(data,pknList,inputs,0.1,alphaWeight = 100,betaWeight =20,scores = scores,nodeWeights = nodeWeights))
# variables <- try(writeLPFile(data,pknList,inputs,0.1))
if(inherits(variables, "try-error")) next
# variables <- writeLPFile(data,pknList,inputs,0.1,alpha=100,beta=20,scores=scores,nodeWeights=nodeWeights)
Elapsed_1 <- proc.time() - ptm
# Solve ILP problem with cplex, remove temp files, and return to the main directory
ptm <- proc.time()
system(paste0(getwd(), "/cplex -f cplexCommand.txt"))
Elapsed_2 <- proc.time() - ptm
# file.remove("testFile.lp")
file.remove("cplex.log")
file.copy(from = "results_cplex.txt",to = paste(current_dir,"/results/",dir_name,"/results_cplex.txt",sep=""))
file.remove("results_cplex.txt")
setwd(current_dir)
# Write result files
ptm <- proc.time()
if (file.exists(paste("results/",dir_name,"/results_cplex.txt",sep=""))) {
for(i in 1:length(variables)){
try(sif <- readOutResult(cplexSolutionFileName = paste("results/",dir_name,"/results_cplex.txt",sep=""), variables = variables, pknList = pknList, conditionIDX = i,dir_name = dir_name, Export_all = Export_all,inputs=inputs,measurements=measurements))
if(inherits(variables, "try-error")) next
}
} else {
print("No result to be written")
}
Elapsed_3 <- proc.time() - ptm
# Logged computational time
ElapsedAll <- as.data.frame(matrix(t(c(Elapsed_1[3],Elapsed_2[3],Elapsed_3[3])),3,1))
rownames(ElapsedAll) <- c("WriteConstraints:","CplexSolving:","ExportResults:")
write.table(x = ElapsedAll,file = paste("results/",dir_name,"/elapsed_time.txt",sep=""),col.names = F,row.names = T,quote = F)
}
}
}
# --- End of script --- #
# [Debug/QC mode] Print variable names
# variables$Condition_1$exp
# --- End of debugging part --- #
# ---------------------- #
# CARNIVAL driver script #
# ---------------------- #
# Integrated pipeline for TransQST dataset
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/TransQST_pipeline/")
rm(list=ls()) # clear environment
cat("\014") # clear screen
# Compounds <- t(read.table(file = "resources/All_Compound_Names.tsv",sep = "\r"))
Compounds <- c("ACETAMINOPHEN","CARBON_TETRACHLORIDE","CYCLOSPORINE","DICLOFENAC","PROPRANOLOL")
CP_NickNames <- c("APAP","CCl4","CYCA","DFN","PPNL")
Conditions <- list()
Conditions[[1]] <- c("low_2h","high_24h")
Conditions[[2]] <- c("low_8h","high_2h")
Conditions[[3]] <- c("low_8h","high_24h")
Conditions[[4]] <- c("low_24h","high_24h")
Conditions[[5]] <- c("low_2h","high_24h")
ScaffoldNet <- c(1,2,3) # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
# ScaffoldNet <- c(1,3) # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
# ScaffoldNet <- 3 # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
ScaffoldName <- c("omnipath","generic","signor")
InputType <- 2 # [1,2] 1 = Only Direct targets; 2 = Direct targets plus STRING
Export_all <- 0 # c(0,1) export all ILP variables or not; if 0, only cplex results, predicted node values and sif file will be written
# for (counter_compound in 1:length(Compounds)) {
for (counter_compound in 3:3) {
for (counter_network in 1:length(ScaffoldNet)) {
for (counter_condition in 1:length(Conditions[[counter_compound]])) {
print("")
print("=========================================")
print(paste0("Optimising compound Nr ", toString(counter_compound),"/",toString(length(Compounds))," : " ,Compounds[counter_compound]," - Using network: ",ScaffoldName[ScaffoldNet[counter_network]]," - ",Conditions[[counter_compound]][counter_condition]))
print("=========================================")
print("")
Network <- ScaffoldNet[counter_network]
NetName <- ScaffoldName[ScaffoldNet[counter_network]]
Result_dir <- paste0(Compounds[counter_compound],"_",NetName,"_",Conditions[[counter_compound]][counter_condition]) # specify a name for result directory; if NULL, then date and time will be used by default
# ============================== #
# Load necessary packages and functions
library(readr)
library(tidyr)
library(XML)
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/"); source("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/src/CRILPR_Functions.R")
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/TransQST_pipeline/")
# Create a directory to store results
current_dir <- getwd()
dir.create("results",showWarnings = FALSE)
setwd(paste(current_dir,"/results",sep=""))
if (is.null(Result_dir)) {
dir_name <- paste("results_",Sys.time(),sep="")
} else {
if (InputType==1) {
dir_name <- paste0("validation_",Result_dir)
} else if (InputType==2) {
dir_name <- paste0("validation_",Result_dir,"_STITCH_input")
}
}
dir.create(dir_name); setwd(current_dir)
# Load ILP inputs
if (Network==1) {
network      <- read.table("data/resources/OmniPathSIF_NoHyphen.tsv", sep = "\t", header = FALSE)
} else if (Network==2) {
network      <- read.table("data/resources/Network_Generic_FIN_RemovedTFGenes_NoHyphen.sif", sep = "\t", header = FALSE)
} else if (Network==3) {
network      <- read.delim("data/resources/SignorSIF_NoHyphenNoSlashNoColonNoSpace.tsv", sep = "\t", header = FALSE)
} else {
stop("Please choose the provided model scaffolds")
}
if (InputType==1) {
# inputs       <- try(read.table(paste0("inputs/Inputs_Main_",Compounds[counter_compound],".tsv"), sep="\t", header = TRUE))
inputs       <- try(read.table(paste0("data/Inputs_Main_",Compounds[counter_compound],".tsv"), sep="\t", header = TRUE))
if(inherits(inputs, "try-error")) next
} else if (InputType==2) {
inputs       <- try(read.table(paste0("data/Inputs_Main_STITCH_",Compounds[counter_compound],"_CutOff_800.tsv"), sep="\t", header = TRUE))
if(inherits(inputs, "try-error")) next
}
measurements <- try(read.table(paste0("data/ILP_Meas_",CP_NickNames[counter_compound],"_",Conditions[[counter_compound]][counter_condition],"_CutOff_1.5.tsv"), sep="\t", header=TRUE))
# measurements <- try(read.table(paste0("data/ILP_Meas_",CP_NickNames[counter_compound],"_",Conditions[[counter_compound]][counter_condition],"_CutOff_2.tsv"), sep="\t", header=TRUE))
if(inherits(measurements, "try-error")) next
# pathwayscore <- NULL
# Input processing
data <- measurements
pknList <- as.data.frame(network)
colnames(pknList) <- c("Node1", "Sign", "Node2")
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/src/") # temporary shift to src directory
if (exists("pathwayscore")) {
if (nrow(pathwayscore)==1) {
if (length(unique(as.numeric(pathwayscore)))!=1) {
nodeWeights <- 1 - 2*((abs(pathwayscore) - min(abs(pathwayscore),na.rm=T)) / (max(abs(pathwayscore),na.rm=T) - min(abs(pathwayscore),na.rm=T)))
} else {
nodeWeights <- pathwayscore # if all pathway scores are the same, then use pathwayscore as the nodeWeights directly
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore); names(scores) <- names(nodeWeights)
} else {
# progenyScores <- read_csv("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/CARNIVAL_Validation/E-MTAB-2091/data/E-MTAB-2091_PROGENy.csv")
# pathwayscore <- progenyScores[,2:ncol(progenyScores)]
pathwayscore_current <- pathwayscore[1,]
nodeWeights <- NULL
for (counter_pw in 1:ncol(pathwayscoreAll)) {
ss <- abs(as.numeric(as.matrix(pathwayscoreAll[, counter_pw])))
nodeWeights <- c(nodeWeights, 1-2*(ss[1]-min(ss, na.rm = TRUE))/(max(ss, na.rm = TRUE)-min(ss, na.rm = TRUE)))
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore_current); names(scores) <- names(nodeWeights)
# names(scores) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
# names(nodeWeights) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
}
} else {
scores <- NULL
nodeWeights <- NULL
}
# Write constraints as ILP inputs
print("Writing constraints...")
if (file.exists("testFile.lp")) {file.remove("testFile.lp")}
if (file.exists("results_cplex.txt")) {file.remove("results_cplex.txt")}
ptm <- proc.time()
variables <- try(writeLPFile(data,pknList,inputs,0.1,alphaWeight = 100,betaWeight =20,scores = scores,nodeWeights = nodeWeights))
# variables <- try(writeLPFile(data,pknList,inputs,0.1))
if(inherits(variables, "try-error")) next
# variables <- writeLPFile(data,pknList,inputs,0.1,alpha=100,beta=20,scores=scores,nodeWeights=nodeWeights)
Elapsed_1 <- proc.time() - ptm
# Solve ILP problem with cplex, remove temp files, and return to the main directory
ptm <- proc.time()
system(paste0(getwd(), "/cplex -f cplexCommand.txt"))
Elapsed_2 <- proc.time() - ptm
# file.remove("testFile.lp")
file.remove("cplex.log")
file.copy(from = "results_cplex.txt",to = paste(current_dir,"/results/",dir_name,"/results_cplex.txt",sep=""))
file.remove("results_cplex.txt")
setwd(current_dir)
# Write result files
ptm <- proc.time()
if (file.exists(paste("results/",dir_name,"/results_cplex.txt",sep=""))) {
for(i in 1:length(variables)){
try(sif <- readOutResult(cplexSolutionFileName = paste("results/",dir_name,"/results_cplex.txt",sep=""), variables = variables, pknList = pknList, conditionIDX = i,dir_name = dir_name, Export_all = Export_all,inputs=inputs,measurements=measurements))
if(inherits(variables, "try-error")) next
}
} else {
print("No result to be written")
}
Elapsed_3 <- proc.time() - ptm
# Logged computational time
ElapsedAll <- as.data.frame(matrix(t(c(Elapsed_1[3],Elapsed_2[3],Elapsed_3[3])),3,1))
rownames(ElapsedAll) <- c("WriteConstraints:","CplexSolving:","ExportResults:")
write.table(x = ElapsedAll,file = paste("results/",dir_name,"/elapsed_time.txt",sep=""),col.names = F,row.names = T,quote = F)
}
}
}
# --- End of script --- #
# [Debug/QC mode] Print variable names
# variables$Condition_1$exp
# --- End of debugging part --- #
# ---------------------- #
# CARNIVAL driver script #
# ---------------------- #
# Integrated pipeline for TransQST dataset
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/TransQST_pipeline/")
rm(list=ls()) # clear environment
cat("\014") # clear screen
# Compounds <- t(read.table(file = "resources/All_Compound_Names.tsv",sep = "\r"))
Compounds <- c("ACETAMINOPHEN","CARBON_TETRACHLORIDE","CYCLOSPORINE","DICLOFENAC","PROPRANOLOL")
CP_NickNames <- c("APAP","CCl4","CYCA","DFN","PPNL")
Conditions <- list()
Conditions[[1]] <- c("low_2h","high_24h")
Conditions[[2]] <- c("low_8h","high_2h")
Conditions[[3]] <- c("low_8h","high_24h")
Conditions[[4]] <- c("low_24h","high_24h")
Conditions[[5]] <- c("low_2h","high_24h")
ScaffoldNet <- c(1,2,3) # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
# ScaffoldNet <- c(1,3) # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
# ScaffoldNet <- 3 # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
ScaffoldName <- c("omnipath","generic","signor")
InputType <- 1 # [1,2] 1 = Only Direct targets; 2 = Direct targets plus STRING
Export_all <- 0 # c(0,1) export all ILP variables or not; if 0, only cplex results, predicted node values and sif file will be written
# for (counter_compound in 1:length(Compounds)) {
for (counter_compound in 3:3) {
for (counter_network in 1:length(ScaffoldNet)) {
for (counter_condition in 1:length(Conditions[[counter_compound]])) {
print("")
print("=========================================")
print(paste0("Optimising compound Nr ", toString(counter_compound),"/",toString(length(Compounds))," : " ,Compounds[counter_compound]," - Using network: ",ScaffoldName[ScaffoldNet[counter_network]]," - ",Conditions[[counter_compound]][counter_condition]))
print("=========================================")
print("")
Network <- ScaffoldNet[counter_network]
NetName <- ScaffoldName[ScaffoldNet[counter_network]]
Result_dir <- paste0(Compounds[counter_compound],"_",NetName,"_",Conditions[[counter_compound]][counter_condition]) # specify a name for result directory; if NULL, then date and time will be used by default
# ============================== #
# Load necessary packages and functions
library(readr)
library(tidyr)
library(XML)
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/"); source("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/src/CRILPR_Functions.R")
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/TransQST_pipeline/")
# Create a directory to store results
current_dir <- getwd()
dir.create("results",showWarnings = FALSE)
setwd(paste(current_dir,"/results",sep=""))
if (is.null(Result_dir)) {
dir_name <- paste("results_",Sys.time(),sep="")
} else {
if (InputType==1) {
dir_name <- paste0("validation_",Result_dir)
} else if (InputType==2) {
dir_name <- paste0("validation_",Result_dir,"_STITCH_input")
}
}
dir.create(dir_name); setwd(current_dir)
# Load ILP inputs
if (Network==1) {
network      <- read.table("data/resources/OmniPathSIF_NoHyphen.tsv", sep = "\t", header = FALSE)
} else if (Network==2) {
network      <- read.table("data/resources/Network_Generic_FIN_RemovedTFGenes_NoHyphen.sif", sep = "\t", header = FALSE)
} else if (Network==3) {
network      <- read.delim("data/resources/SignorSIF_NoHyphenNoSlashNoColonNoSpace.tsv", sep = "\t", header = FALSE)
} else {
stop("Please choose the provided model scaffolds")
}
if (InputType==1) {
# inputs       <- try(read.table(paste0("inputs/Inputs_Main_",Compounds[counter_compound],".tsv"), sep="\t", header = TRUE))
inputs       <- try(read.table(paste0("data/Inputs_Main_",Compounds[counter_compound],".tsv"), sep="\t", header = TRUE))
if(inherits(inputs, "try-error")) next
} else if (InputType==2) {
inputs       <- try(read.table(paste0("data/Inputs_Main_STITCH_",Compounds[counter_compound],"_CutOff_800.tsv"), sep="\t", header = TRUE))
if(inherits(inputs, "try-error")) next
}
# measurements <- try(read.table(paste0("data/ILP_Meas_",CP_NickNames[counter_compound],"_",Conditions[[counter_compound]][counter_condition],"_CutOff_1.5.tsv"), sep="\t", header=TRUE))
measurements <- try(read.table(paste0("data/ILP_Meas_",CP_NickNames[counter_compound],"_",Conditions[[counter_compound]][counter_condition],"_CutOff_2.tsv"), sep="\t", header=TRUE))
if(inherits(measurements, "try-error")) next
# pathwayscore <- NULL
# Input processing
data <- measurements
pknList <- as.data.frame(network)
colnames(pknList) <- c("Node1", "Sign", "Node2")
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/src/") # temporary shift to src directory
if (exists("pathwayscore")) {
if (nrow(pathwayscore)==1) {
if (length(unique(as.numeric(pathwayscore)))!=1) {
nodeWeights <- 1 - 2*((abs(pathwayscore) - min(abs(pathwayscore),na.rm=T)) / (max(abs(pathwayscore),na.rm=T) - min(abs(pathwayscore),na.rm=T)))
} else {
nodeWeights <- pathwayscore # if all pathway scores are the same, then use pathwayscore as the nodeWeights directly
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore); names(scores) <- names(nodeWeights)
} else {
# progenyScores <- read_csv("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/CARNIVAL_Validation/E-MTAB-2091/data/E-MTAB-2091_PROGENy.csv")
# pathwayscore <- progenyScores[,2:ncol(progenyScores)]
pathwayscore_current <- pathwayscore[1,]
nodeWeights <- NULL
for (counter_pw in 1:ncol(pathwayscoreAll)) {
ss <- abs(as.numeric(as.matrix(pathwayscoreAll[, counter_pw])))
nodeWeights <- c(nodeWeights, 1-2*(ss[1]-min(ss, na.rm = TRUE))/(max(ss, na.rm = TRUE)-min(ss, na.rm = TRUE)))
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore_current); names(scores) <- names(nodeWeights)
# names(scores) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
# names(nodeWeights) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
}
} else {
scores <- NULL
nodeWeights <- NULL
}
# Write constraints as ILP inputs
print("Writing constraints...")
if (file.exists("testFile.lp")) {file.remove("testFile.lp")}
if (file.exists("results_cplex.txt")) {file.remove("results_cplex.txt")}
ptm <- proc.time()
variables <- try(writeLPFile(data,pknList,inputs,0.1,alphaWeight = 100,betaWeight =20,scores = scores,nodeWeights = nodeWeights))
# variables <- try(writeLPFile(data,pknList,inputs,0.1))
if(inherits(variables, "try-error")) next
# variables <- writeLPFile(data,pknList,inputs,0.1,alpha=100,beta=20,scores=scores,nodeWeights=nodeWeights)
Elapsed_1 <- proc.time() - ptm
# Solve ILP problem with cplex, remove temp files, and return to the main directory
ptm <- proc.time()
system(paste0(getwd(), "/cplex -f cplexCommand.txt"))
Elapsed_2 <- proc.time() - ptm
# file.remove("testFile.lp")
file.remove("cplex.log")
file.copy(from = "results_cplex.txt",to = paste(current_dir,"/results/",dir_name,"/results_cplex.txt",sep=""))
file.remove("results_cplex.txt")
setwd(current_dir)
# Write result files
ptm <- proc.time()
if (file.exists(paste("results/",dir_name,"/results_cplex.txt",sep=""))) {
for(i in 1:length(variables)){
try(sif <- readOutResult(cplexSolutionFileName = paste("results/",dir_name,"/results_cplex.txt",sep=""), variables = variables, pknList = pknList, conditionIDX = i,dir_name = dir_name, Export_all = Export_all,inputs=inputs,measurements=measurements))
if(inherits(variables, "try-error")) next
}
} else {
print("No result to be written")
}
Elapsed_3 <- proc.time() - ptm
# Logged computational time
ElapsedAll <- as.data.frame(matrix(t(c(Elapsed_1[3],Elapsed_2[3],Elapsed_3[3])),3,1))
rownames(ElapsedAll) <- c("WriteConstraints:","CplexSolving:","ExportResults:")
write.table(x = ElapsedAll,file = paste("results/",dir_name,"/elapsed_time.txt",sep=""),col.names = F,row.names = T,quote = F)
}
}
}
# --- End of script --- #
# [Debug/QC mode] Print variable names
# variables$Condition_1$exp
# --- End of debugging part --- #
# ---------------------- #
# CARNIVAL driver script #
# ---------------------- #
# Integrated pipeline for TransQST dataset
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/TransQST_pipeline/")
rm(list=ls()) # clear environment
cat("\014") # clear screen
# Compounds <- t(read.table(file = "resources/All_Compound_Names.tsv",sep = "\r"))
Compounds <- c("ACETAMINOPHEN","CARBON_TETRACHLORIDE","CYCLOSPORINE","DICLOFENAC","PROPRANOLOL")
CP_NickNames <- c("APAP","CCl4","CYCA","DFN","PPNL")
Conditions <- list()
Conditions[[1]] <- c("low_2h","high_24h")
Conditions[[2]] <- c("low_8h","high_2h")
Conditions[[3]] <- c("low_8h","high_24h")
Conditions[[4]] <- c("low_24h","high_24h")
Conditions[[5]] <- c("low_2h","high_24h")
ScaffoldNet <- c(1,2,3) # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
# ScaffoldNet <- c(1,3) # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
# ScaffoldNet <- 3 # c(1,2,3,4) # Model2 [Signor] has an issue with writeSIF and Model3 [Babur] is too large to write constraints
ScaffoldName <- c("omnipath","generic","signor")
InputType <- 2 # [1,2] 1 = Only Direct targets; 2 = Direct targets plus STRING
Export_all <- 0 # c(0,1) export all ILP variables or not; if 0, only cplex results, predicted node values and sif file will be written
# for (counter_compound in 1:length(Compounds)) {
for (counter_compound in 3:3) {
for (counter_network in 1:length(ScaffoldNet)) {
for (counter_condition in 1:length(Conditions[[counter_compound]])) {
print("")
print("=========================================")
print(paste0("Optimising compound Nr ", toString(counter_compound),"/",toString(length(Compounds))," : " ,Compounds[counter_compound]," - Using network: ",ScaffoldName[ScaffoldNet[counter_network]]," - ",Conditions[[counter_compound]][counter_condition]))
print("=========================================")
print("")
Network <- ScaffoldNet[counter_network]
NetName <- ScaffoldName[ScaffoldNet[counter_network]]
Result_dir <- paste0(Compounds[counter_compound],"_",NetName,"_",Conditions[[counter_compound]][counter_condition]) # specify a name for result directory; if NULL, then date and time will be used by default
# ============================== #
# Load necessary packages and functions
library(readr)
library(tidyr)
library(XML)
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/"); source("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/src/CRILPR_Functions.R")
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/TransQST_pipeline/")
# Create a directory to store results
current_dir <- getwd()
dir.create("results",showWarnings = FALSE)
setwd(paste(current_dir,"/results",sep=""))
if (is.null(Result_dir)) {
dir_name <- paste("results_",Sys.time(),sep="")
} else {
if (InputType==1) {
dir_name <- paste0("validation_",Result_dir)
} else if (InputType==2) {
dir_name <- paste0("validation_",Result_dir,"_STITCH_input")
}
}
dir.create(dir_name); setwd(current_dir)
# Load ILP inputs
if (Network==1) {
network      <- read.table("data/resources/OmniPathSIF_NoHyphen.tsv", sep = "\t", header = FALSE)
} else if (Network==2) {
network      <- read.table("data/resources/Network_Generic_FIN_RemovedTFGenes_NoHyphen.sif", sep = "\t", header = FALSE)
} else if (Network==3) {
network      <- read.delim("data/resources/SignorSIF_NoHyphenNoSlashNoColonNoSpace.tsv", sep = "\t", header = FALSE)
} else {
stop("Please choose the provided model scaffolds")
}
if (InputType==1) {
# inputs       <- try(read.table(paste0("inputs/Inputs_Main_",Compounds[counter_compound],".tsv"), sep="\t", header = TRUE))
inputs       <- try(read.table(paste0("data/Inputs_Main_",Compounds[counter_compound],".tsv"), sep="\t", header = TRUE))
if(inherits(inputs, "try-error")) next
} else if (InputType==2) {
inputs       <- try(read.table(paste0("data/Inputs_Main_STITCH_",Compounds[counter_compound],"_CutOff_800.tsv"), sep="\t", header = TRUE))
if(inherits(inputs, "try-error")) next
}
# measurements <- try(read.table(paste0("data/ILP_Meas_",CP_NickNames[counter_compound],"_",Conditions[[counter_compound]][counter_condition],"_CutOff_1.5.tsv"), sep="\t", header=TRUE))
measurements <- try(read.table(paste0("data/ILP_Meas_",CP_NickNames[counter_compound],"_",Conditions[[counter_compound]][counter_condition],"_CutOff_2.tsv"), sep="\t", header=TRUE))
if(inherits(measurements, "try-error")) next
# pathwayscore <- NULL
# Input processing
data <- measurements
pknList <- as.data.frame(network)
colnames(pknList) <- c("Node1", "Sign", "Node2")
setwd("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/src/") # temporary shift to src directory
if (exists("pathwayscore")) {
if (nrow(pathwayscore)==1) {
if (length(unique(as.numeric(pathwayscore)))!=1) {
nodeWeights <- 1 - 2*((abs(pathwayscore) - min(abs(pathwayscore),na.rm=T)) / (max(abs(pathwayscore),na.rm=T) - min(abs(pathwayscore),na.rm=T)))
} else {
nodeWeights <- pathwayscore # if all pathway scores are the same, then use pathwayscore as the nodeWeights directly
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore); names(scores) <- names(nodeWeights)
} else {
# progenyScores <- read_csv("~/Desktop/RWTH_Aachen/GitHub/CARNIVAL/archive/CARNIVAL_Validation/E-MTAB-2091/data/E-MTAB-2091_PROGENy.csv")
# pathwayscore <- progenyScores[,2:ncol(progenyScores)]
pathwayscore_current <- pathwayscore[1,]
nodeWeights <- NULL
for (counter_pw in 1:ncol(pathwayscoreAll)) {
ss <- abs(as.numeric(as.matrix(pathwayscoreAll[, counter_pw])))
nodeWeights <- c(nodeWeights, 1-2*(ss[1]-min(ss, na.rm = TRUE))/(max(ss, na.rm = TRUE)-min(ss, na.rm = TRUE)))
}
names(nodeWeights) <- colnames(pathwayscore)
scores <- as.numeric(pathwayscore_current); names(scores) <- names(nodeWeights)
# names(scores) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
# names(nodeWeights) <- c("AR", "EGFR", "ESR1", "HIF1A", "JAK1", "MAPK1", "NFKB1", "PIK3CA", "TGFBR1", "TNFRSF1A", "TNFSF10", "KDR", "CTNNB1", "TP53")
}
} else {
scores <- NULL
nodeWeights <- NULL
}
# Write constraints as ILP inputs
print("Writing constraints...")
if (file.exists("testFile.lp")) {file.remove("testFile.lp")}
if (file.exists("results_cplex.txt")) {file.remove("results_cplex.txt")}
ptm <- proc.time()
variables <- try(writeLPFile(data,pknList,inputs,0.1,alphaWeight = 100,betaWeight =20,scores = scores,nodeWeights = nodeWeights))
# variables <- try(writeLPFile(data,pknList,inputs,0.1))
if(inherits(variables, "try-error")) next
# variables <- writeLPFile(data,pknList,inputs,0.1,alpha=100,beta=20,scores=scores,nodeWeights=nodeWeights)
Elapsed_1 <- proc.time() - ptm
# Solve ILP problem with cplex, remove temp files, and return to the main directory
ptm <- proc.time()
system(paste0(getwd(), "/cplex -f cplexCommand.txt"))
Elapsed_2 <- proc.time() - ptm
# file.remove("testFile.lp")
file.remove("cplex.log")
file.copy(from = "results_cplex.txt",to = paste(current_dir,"/results/",dir_name,"/results_cplex.txt",sep=""))
file.remove("results_cplex.txt")
setwd(current_dir)
# Write result files
ptm <- proc.time()
if (file.exists(paste("results/",dir_name,"/results_cplex.txt",sep=""))) {
for(i in 1:length(variables)){
try(sif <- readOutResult(cplexSolutionFileName = paste("results/",dir_name,"/results_cplex.txt",sep=""), variables = variables, pknList = pknList, conditionIDX = i,dir_name = dir_name, Export_all = Export_all,inputs=inputs,measurements=measurements))
if(inherits(variables, "try-error")) next
}
} else {
print("No result to be written")
}
Elapsed_3 <- proc.time() - ptm
# Logged computational time
ElapsedAll <- as.data.frame(matrix(t(c(Elapsed_1[3],Elapsed_2[3],Elapsed_3[3])),3,1))
rownames(ElapsedAll) <- c("WriteConstraints:","CplexSolving:","ExportResults:")
write.table(x = ElapsedAll,file = paste("results/",dir_name,"/elapsed_time.txt",sep=""),col.names = F,row.names = T,quote = F)
}
}
}
# --- End of script --- #
# [Debug/QC mode] Print variable names
# variables$Condition_1$exp
# --- End of debugging part --- #
